# Firestore Data Examples - Queue Lifecycle Notifications

## Database Paths

All notifications are written to Firestore under:
```
firestore/patients/{uid}/inbox/{autoGeneratedDocId}
```

---

## Notification Examples by Scenario

### Scenario 1: New Patient - Request Accepted

**Event**: Counter staff clicks ACCEPT on queue request  
**Trigger**: User accepted a new queue request (no existing arrivalIndex)  
**Code Line**: 975-983

**Firestore Path**:
```
patients/kwQbAxs1NGcTLZnFuLlLpxUnMgE2/inbox/randomDocId123
```

**Firestore Document**:
```json
{
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter1",
  "counterName": "Registration",
  "type": "arrival_update",
  "status": "awaiting_arrival",
  "message": "Your request has been accepted. Please proceed to check in.",
  "chainOrder": 0,
  "timestamp": Timestamp(2026, 2, 2, 10, 30, 45, 123000000)
}
```

**Android Display**:
- Pill: "ARRIVAL" (warning color)
- Title: "Arrival Update"
- Message: "Your request has been accepted. Please proceed to check in."
- Status Line: "Awaiting Arrival"

---

### Scenario 2: Patient Arrives (RFID/PIN Scan)

**Event**: Patient scans RFID or enters PIN at health gate  
**Trigger**: Arrival record created, processed by arrivalsRef listener  
**Code Line**: 2195-2203

**Firestore Path**:
```
patients/kwQbAxs1NGcTLZnFuLlLpxUnMgE2/inbox/randomDocId124
```

**Firestore Document**:
```json
{
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter1",
  "counterName": "Registration",
  "type": "arrival_update",
  "status": "waiting",
  "message": "You are now in the queue at Registration.",
  "chainOrder": 0,
  "timestamp": Timestamp(2026, 2, 2, 10, 35, 12, 456000000)
}
```

**Android Display**:
- Added to: Active Queues list
- Position: Based on queue order
- Message: Shown in queue list

---

### Scenario 3: Service Starts (Admit Next)

**Event**: Counter staff clicks "Admit Next" button  
**Trigger**: Patient moves from "waiting" to "in_service"  
**Code Line**: 1664-1673

**Firestore Path**:
```
patients/kwQbAxs1NGcTLZnFuLlLpxUnMgE2/inbox/randomDocId125
```

**Firestore Document**:
```json
{
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter1",
  "counterName": "Registration",
  "type": "arrival_update",
  "status": "in_service",
  "message": "You are now being served at Registration.",
  "chainOrder": 0,
  "timestamp": Timestamp(2026, 2, 2, 10, 40, 22, 789000000)
}
```

**Android Display**:
- Pill: "ARRIVAL" (warning color)
- Title: "Arrival Update"
- Message: "You are now being served at Registration."
- Status Line: "In Service"

---

### Scenario 4: Service Complete (Final, No Chain)

**Event**: Counter staff clicks "End Service"  
**Trigger**: No more accepted requests in patient's queue (no chain)  
**Code Line**: 1943-1952

**Firestore Path**:
```
patients/kwQbAxs1NGcTLZnFuLlLpxUnMgE2/inbox/randomDocId126
```

**Firestore Document**:
```json
{
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter1",
  "counterName": "Registration",
  "type": "arrival_update",
  "status": "completed",
  "message": "Your service has been completed. Thank you for visiting!",
  "chainOrder": 0,
  "timestamp": Timestamp(2026, 2, 2, 10, 50, 45, 123000000)
}
```

**Android Display**:
- Removed from: Active Queues
- Added to: Recently Visited
- Shows: Visit record with timestamp

---

### Scenario 5: Chain Queue - Second Request Accepted

**Event**: Counter staff accepts 2nd service request (patient already has arrivalIndex)  
**Trigger**: Patient has active arrivalIndex, new request accepted  
**Code Line**: 987-998

**Firestore Path**:
```
patients/kwQbAxs1NGcTLZnFuLlLpxUnMgE2/inbox/randomDocId127
```

**Firestore Document**:
```json
{
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter2",
  "counterName": "Cashier",
  "type": "arrival_update",
  "status": "waiting",
  "message": "You've been added to a chained queue. Please wait for the next available counter.",
  "chainOrder": 1,
  "timestamp": Timestamp(2026, 2, 2, 10, 32, 15, 456000000)
}
```

**Android Display**:
- Pill: "⚓ Queue #1" (primary color)
- Title: "Queue Update"
- Message: "You're next in a chained queue"
- Status Line: "Chained Queue"

---

### Scenario 6: Chain Queue Auto-Progression

**Event**: Patient completes 1st service, auto-queued to 2nd counter  
**Trigger**: Service completion with next accepted request found  
**Code Line**: 1850-1859

**Firestore Path**:
```
patients/kwQbAxs1NGcTLZnFuLlLpxUnMgE2/inbox/randomDocId128
```

**Firestore Document**:
```json
{
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter2",
  "counterName": "Cashier",
  "type": "arrival_update",
  "status": "waiting",
  "message": "Please proceed to Cashier for the next step of your service.",
  "chainOrder": 1,
  "timestamp": Timestamp(2026, 2, 2, 10, 55, 30, 789000000)
}
```

**Android Display**:
- Pill: "⚓ Queue #1" (primary color)
- Message: Updated to reflect next counter
- Status: "Chained Queue"

---

### Scenario 7: Request Rejected

**Event**: Counter staff clicks REJECT on pending request  
**Trigger**: Request explicitly rejected by counter staff  
**Code Line**: 1042-1048

**Firestore Path**:
```
patients/kwQbAxs1NGcTLZnFuLlLpxUnMgE2/inbox/randomDocId129
```

**Firestore Document**:
```json
{
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter1",
  "counterName": "Registration",
  "type": "arrival_update",
  "status": "rejected",
  "message": "Your request has been rejected at Registration.",
  "chainOrder": 0,
  "timestamp": Timestamp(2026, 2, 2, 10, 33, 00, 000000000)
}
```

**Android Display**:
- Hidden from notifications (not shown to user)
- May appear in MyRequestsActivity

---

## RTDB Comparison

### Same Event Also Creates RTDB Entry

**RTDB Path**:
```
patients/{uid}/notifications/{notifKey}
```

**RTDB Document**:
```json
{
  "type": "queue",
  "estId": "-OaLChP8gA0v7MLD5RG-",
  "estName": "City Hospital",
  "counterId": "counter1",
  "counterName": "Registration",
  "message": "Your request has been accepted. Please proceed to check in.",
  "timestamp": 1743753045123
}
```

**Differences from Firestore**:
- RTDB: No `status` field (legacy)
- RTDB: No `chainOrder` field
- RTDB: `type: "queue"` (generic)
- Firestore: Rich status and chain information
- **Both**: Are created simultaneously (dual-write)

---

## Data Flow Diagram

```
Counter Staff Action
        ↓
   [RTDB Update]
   (Atomic write)
        ↓
   [Firestore Write]
   (Async notification)
        ↓
Android Listener
   (Firestore)
        ↓
NotificationAdapter
   (Displays in UI)
        ↓
Active Queues Update
   (Real-time)
```

---

## Field Reference

### Required Fields
| Field | Type | Example |
|-------|------|---------|
| `estId` | String | "-OaLChP8gA0v7MLD5RG-" |
| `estName` | String | "City Hospital" |
| `counterId` | String | "counter1" |
| `counterName` | String | "Registration" |
| `type` | String | "arrival_update" |
| `status` | String | "awaiting_arrival", "waiting", "in_service", "completed", "rejected" |
| `message` | String | "Your message here" |
| `timestamp` | Timestamp | auto-generated by Firestore |

### Optional Fields
| Field | Type | Use Case |
|-------|------|----------|
| `chainOrder` | Number | Multi-step services (0 = single step) |

---

## Status Value Reference

| Status | Meaning | Android Display | Chain? |
|--------|---------|-----------------|--------|
| `awaiting_arrival` | Waiting for health gate scan | "ARRIVAL" pill | N/A |
| `waiting` | In queue, waiting to be served | Active Queue | chainOrder=0 |
| `in_service` | Currently being served | "ARRIVAL" pill | N/A |
| `completed` | Service finished | Recently Visited | N/A |
| `rejected` | Request rejected | Hidden | N/A |

---

## Timestamp Behavior

### Firestore Timestamp
```javascript
timestamp: firebase.firestore.FieldValue.serverTimestamp()
```

**Result**: Firestore automatically sets this to server time  
**Example**: `Timestamp(2026, 2, 2, 10, 30, 45, 123000000)`

### Benefits
✅ No client time skew  
✅ Consistent across all devices  
✅ Accurate sequencing  
✅ For Recently Visited sorting  

---

## Example Collection Structure

```
patients/
├── kwQbAxs1NGcTLZnFuLlLpxUnMgE2/
│   ├── inbox/
│   │   ├── randomDocId123/
│   │   │   ├── estId: "-OaLChP8gA0v7MLD5RG-"
│   │   │   ├── estName: "City Hospital"
│   │   │   ├── counterId: "counter1"
│   │   │   ├── counterName: "Registration"
│   │   │   ├── type: "arrival_update"
│   │   │   ├── status: "awaiting_arrival"
│   │   │   ├── message: "Your request has been accepted..."
│   │   │   ├── chainOrder: 0
│   │   │   └── timestamp: Timestamp(2026, 2, 2, 10, 30, 45)
│   │   ├── randomDocId124/
│   │   │   └── status: "waiting"
│   │   │       └── ...
│   │   └── randomDocId125/
│   │       └── status: "in_service"
│   │           └── ...
│   └── appointments/
│       └── (for future use)
```

---

## Testing: What to Look For

### In Firestore Console
1. Navigate to: `firestore.firebase.google.com`
2. Select project: `q-now-7d98a`
3. Go to: `patients` → `{uid}` → `inbox`
4. Click "Refresh" after each action
5. Should see new documents appear in real-time

### Documents You'll See
- ✅ "awaiting_arrival" when counter accepts request
- ✅ "waiting" when patient arrives
- ✅ "in_service" when service starts
- ✅ "completed" when service ends (final)
- ✅ "rejected" if request is rejected

### Field Values to Verify
- [x] `estId` matches establishment
- [x] `estName` readable name
- [x] `counterId` correct counter
- [x] `counterName` readable name
- [x] `status` matches scenario
- [x] `message` customer-friendly
- [x] `chainOrder` correct (0 for single, N for chain)
- [x] `timestamp` recent (server time)

---

## Debugging Tips

### View Firestore Writes in Console
```javascript
// Open browser DevTools (F12)
// Look for console logs:
✅ Pushed arrival notification to patient kwQbAxs1NGcTLZnFuLlLpxUnMgE2: 
   Object { estId: "-OaLChP8gA0v7MLD5RG-", estName: "City Hospital", ... }
```

### Check Firestore Rules (if writes fail)
```javascript
// Error in console:
❌ Error pushing arrival notification: 
   FirebaseError: [permission-denied]: Missing or insufficient permissions
```

**Solution**: Update Firestore security rules to allow writes to `inbox`

### Verify Android Receives
1. Open Android app
2. Go to Notifications section
3. Should see notifications in real-time
4. Check timestamp matches server time

---

## Summary

This document provides real-world examples of what Firestore notifications look like at each stage of a patient's queue journey. Use these examples to:

1. **Understand** the data structure
2. **Verify** your implementation
3. **Debug** any issues
4. **Test** with real data

**Next Step**: Deploy and verify in staging environment that all notifications appear correctly.
